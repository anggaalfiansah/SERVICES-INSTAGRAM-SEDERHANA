"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MqttListener = void 0;
const mqtt_utilities_1 = require("./mqtt.utilities");
class MqttListener {
    constructor() {
        this.handlers = [];
    }
    handleMessage(message) {
        return Promise.all(this.handlers
            .filter(h => mqtt_utilities_1.matchTopic(h.topicFilter, message.topic))
            .map(async (handler) => {
            const params = handler.paramMatcher ? mqtt_utilities_1.extractParams(handler.paramMatcher, message.topic) : {};
            if (handler.validator && !handler.validator(message, params))
                return;
            const finalMessage = {
                ...message,
                params,
            };
            handler.handle(handler.transformer ? await handler.transformer(finalMessage) : finalMessage);
        }));
    }
    addHandler(handler) {
        this.handlers.push(handler);
        return () => (this.handlers = this.handlers.filter(x => x !== handler));
    }
}
exports.MqttListener = MqttListener;
//# sourceMappingURL=mqtt.listener.js.map